# デバッグレポート

## 報告された問題

### 1. エッジ選択のバグ
**症状**: 絶対値が小さいのはBCなのになぜCAになってる？
- 入力例: `{"A,B": -0.8, "A,C": -0.7, "B,C": -0.6}`
- 期待: BC (abs=0.6, 最小)
- 実際: CA (abs=0.7, 不正解)

### 2. 早期スキップ問題
**症状**: 人間1発話でスキップされてしまう

---

## 調査結果

### エッジ選択ロジックの検証

#### ✅ 単体テスト (test_edge_selection.py)
3つのテストケースすべてが **PASS**:
1. カンマ付きエッジキー: `{"A,B": -0.8, "A,C": -0.7, "B,C": -0.6}` → 正しくBCを選択
2. タプル形式: `{("A","B"): -0.8, ("A","C"): -0.7, ("B","C"): -0.6}` → 正しくBCを選択  
3. 逆順: `{("B","A"): -0.8, ("C","A"): -0.7, ("B","C"): -0.6}` → 正しくBCを選択

**結論**: アルゴリズムロジックは正しい

#### ✅ プロダクション環境テスト (test_production_edge_selection.py)
実際の`ConversationEnv`を使った統合テストでも正常動作:
```
3. 全エッジの内容:
   ('A', 'B') (tuple): -0.8000
   ('A', 'C') (tuple): 0.2000
   ('B', 'C') (tuple): 0.3000

4. マイナスのエッジを抽出:
   ('A', 'B'): -0.8000 (abs=0.8000)

6. 選択されたエッジ: ('A', 'B') (score=-0.8000, abs=0.8000)
```

**結論**: プロダクション環境でも正しく動作

#### 🔍 デバッグ出力追加済み
以下の箇所に詳細なデバッグ出力を追加:
1. `app/env/convo_env.py` lines 1144-1210 (_parse_plan)
2. `app/ppo_train.py` lines 440-510 (_validate_plan_json)

出力内容:
- エッジ辞書の取得
- 負のエッジの抽出（各エッジの絶対値を表示）
- ソート後のリスト
- 選択されたエッジ
- 正規化プロセス

### 早期スキップ問題の調査

#### ✅ step()メソッドテスト (test_step_logic.py)
正常動作を確認:
```
2. step('2') を実行（bridge戦略で介入）
  ステップ1: reset()で既に3発話生成済み
  [auto_skip] ループ終了: auto_skip_count=0, human_replies_before=0件
  
   結果:
   - 介入: True
   - ログ数: 7

3. step('4') を実行（介入しない）
   結果:
   - 介入: False
   - ログ数: 7
```

**観察された動作**:
- `reset()`で3発話生成
- 最初の`step()`で介入+evaluation_horizon=3の人間発話 → 合計7発話
- 2回目の`step()`では発話数が増えない（介入しないため）

#### 🔍 auto_skipループの動作
`reset()`とstep()`の両方に`auto_skip`ループが存在:
- **目的**: 安定状態をスキップして不安定状態まで進める
- **設定**: `max_auto_skip=10` (最大10回の人間発話を自動生成)
- **終了条件**:
  1. 不安定トライアドが検出された
  2. 10回試しても不安定にならない → 話題を切り替え
  3. `skip_stable=False`の場合は実行しない

**ログ例**:
```
[reset auto_skip] 安定状態を検出、人間発話を自動生成 (1/10)
[reset auto_skip] 安定状態を検出、人間発話を自動生成 (2/10)
...
[reset auto_skip] 10回試しても不安定にならず → 話題を切り替え
```

---

## 考えられる原因

### エッジ選択バグについて
テストでは再現しないため、以下の可能性:

1. **タイミング問題**: ユーザーが見たログと実際の選択時で関係性が変化している
2. **異なるコードパス**: PPOトレーニング中の別のロジックが使われている
3. **デバッグ出力の不整合**: ログ表示と実際の処理で異なる値を見ている

**次のステップ**: 実際のPPOトレーニングを実行し、追加したデバッグ出力を確認

### 早期スキップ問題について
「1発話でスキップ」は以下の可能性:

1. **evaluation_horizon後の状態**: 介入後にevaluation_horizon=3回の人間発話が生成されるが、その後は`intervene_now=False`の場合に新しい発話が生成されない
2. **filter_zero_rewards機能**: `config.local.yaml`の設定で、報酬がゼロの場合に早期終了する機能が有効化されている可能性
3. **auto_skipループ**: `skip_stable=True`の場合、安定状態が続くと10回まで自動生成するが、不安定になるまで待機しない

**次のステップ**: 
- `filter_zero_rewards`設定を確認
- `skip_stable`の動作を詳しく調査
- 実際のPPOトレーニングログを確認

---

## 追加されたファイル

### テストファイル
1. **test_edge_selection.py**: エッジ選択ロジックの単体テスト (全3ケース PASS)
2. **test_production_edge_selection.py**: プロダクション環境での統合テスト
3. **test_step_logic.py**: step()メソッドの動作テスト

### デバッグ出力
- `app/env/convo_env.py` (_parse_plan): エッジ選択の詳細ログ
- `app/ppo_train.py` (_validate_plan_json): エッジ選択の詳細ログ
- `debug=True`で有効化

---

## 推奨アクション

### 即座に実行可能
1. **PPOトレーニングを実行してデバッグ出力を確認**:
   ```bash
   python app/ppo_train.py --config app/config.local.yaml
   ```
   - エッジ選択の実際のプロセスを観察
   - CA選択のケースが再現されるか確認

2. **filter_zero_rewards設定を確認**:
   ```bash
   grep -r "filter_zero_rewards" app/config.local.yaml
   ```

3. **skip_stable設定を調整**:
   `config.local.yaml`で`skip_stable: false`に設定してテスト

### 中長期的な改善
1. エッジ選択のassertionを追加（選択されたエッジが本当に最小絶対値か検証）
2. auto_skipループの動作をより明確に制御できる設定を追加
3. 早期終了の条件を明示的にログ出力

---

## まとめ

- ✅ エッジ選択ロジックは単体テストとプロダクション環境テストで正常動作
- ✅ デバッグ出力を追加済み（実際のPPOトレーニングで確認が必要）
- ⚠️ 早期スキップ問題は再現せず（異なる設定や条件下で発生する可能性）
- 📋 次のステップ: 実際のPPOトレーニングでデバッグ出力を確認し、問題を特定
