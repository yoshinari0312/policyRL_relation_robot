# 介入判定シミュレーションガイド

## 概要

`simulate_intervention.py` は、複数のモデル（GPT5またはQwen3学習前モデル）を使用して、会話環境での介入判定をシミュレートするツールです。

## 主な機能

- **モデル切り替え**: GPT5（Azure OpenAI）またはQwen3学習前モデルを選択可能
- **介入判定LLM出力の可視化**: 各モデルの生出力をターミナルに表示
- **max_steps制御**: 発話数ではなく、ステップ数で終了条件を制御
- **プロンプト最適化**: PPOトレーニングと同じプロンプトフォーマットを使用
- **Qwen3対応**: `\no_think` プレフィックスを自動追加

## 使用方法

### GPT5モデルでのシミュレーション

```bash
# デフォルト（5セッション、8ステップ）
python app/simulate_intervention.py --model gpt5

# カスタム設定
python app/simulate_intervention.py --model gpt5 --num-sessions 3 --max-steps 5
```

### Qwen3学習前モデルでのシミュレーション

```bash
# デフォルト（5セッション、8ステップ）
python app/simulate_intervention.py --model qwen3

# カスタム設定
python app/simulate_intervention.py --model qwen3 --num-sessions 3 --max-steps 5
```

### オプション

- `--model {gpt5,qwen3}`: 使用するモデル（デフォルト: gpt5）
- `--num-sessions N`: シミュレートするセッション数（デフォルト: 5）
- `--max-steps N`: 1エピソードあたりの最大ステップ数（デフォルト: 8）
- `--quiet`: 詳細な出力を抑制

## 主な変更点（従来のsimulate_gpt5_intervention.pyから）

### 1. max_stepsで終了するように変更

**変更前**: 
- `target_human_utterances` （人間の発話数）で終了
- `max_rounds` に基づいて計算

**変更後**:
- `max_steps` で終了
- ステップ数が明確に制御可能

### 2. Qwen3モデル対応

**追加機能**:
- Qwen3モデルのロード処理を追加
- システムプロンプトに `\no_think` を自動付与
- Transformersライブラリを使用した推論

### 3. プロンプト最適化

**改善内容**:
- PPO訓練と同じプロンプトフォーマットを使用
- 戦略（reframe/validate/bridge）の詳細な説明を追加
- JSON出力形式の明確化

### 4. 介入判定LLMの生出力表示

**表示内容**:
- GPT5/Qwen3の生の出力をターミナルに表示
- JSON抽出前の完全な応答を確認可能
- デバッグとモデル挙動の分析に有用

## 出力例

### セッション開始時
```
================================================================================
セッション 1 開始 (モデル: GPT5)
================================================================================

📌 話題: 都市の緑化と生態系への影響
👥 ペルソナ: A, B, C

💬 初期会話履歴（reset()で生成、ステップ1の入力）:
  1. [A] おい、都市の緑化なんてただのパフォーマンスだろ...
  ...
```

### 介入判定時
```
🤖 GPT5生出力:
--------------------------------------------------------------------------------
{"intervene_now": true, "edge_to_change": "AB", "strategy": "validate", "target_speaker": "A"}
--------------------------------------------------------------------------------

🤖 GPT5介入判定結果:
  介入判定: ✅ 介入する
  対象エッジ: AB
  戦略: validate
  対象話者: A
```

### セッション終了時
```
================================================================================
セッション 1 終了
================================================================================
総ステップ数: 3
総介入回数: 2
総報酬: 1.1600
平均ステップ報酬: 0.3867
```

## トラブルシューティング

### Qwen3モデルがロードできない

**原因**: Transformersライブラリがインストールされていない

**解決策**:
```bash
pip install transformers torch
```

### メモリ不足エラー

**原因**: Qwen3モデルのロードにメモリが不足

**解決策**:
- より小さいバッチサイズを使用
- GPUメモリを確保
- GPT5モデルを使用

### Azure OpenAI接続エラー

**原因**: 認証情報が正しく設定されていない

**解決策**:
- `config.local.yaml` のAzure設定を確認
- 環境変数 `AZURE_OPENAI_API_KEY` を設定

## 関連ファイル

- `app/simulate_intervention.py`: メインスクリプト
- `app/simulate_gpt5_intervention.py`: 旧バージョン（GPT5のみ）
- `app/env/convo_env.py`: 会話環境
- `app/config.local.yaml`: 設定ファイル
- `app/ppo_train.py`: PPOトレーニングスクリプト

## 今後の拡張

- [ ] 他のLLM（Claude、Geminiなど）への対応
- [ ] バッチ処理での並列実行
- [ ] 結果のCSV/JSON出力機能
- [ ] グラフ可視化機能
