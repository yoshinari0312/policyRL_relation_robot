# 地雷システムの設計ドキュメント

## 概要

このドキュメントでは、3者会話における地雷（トリガー）システムの設計と実装について説明します。

## 設計要件

1. **自分の地雷を共通地雷から除外**: 他の2人に共通する地雷でも、自分の地雷である場合は優しくしない
2. **構造バランス**: 以下の条件を満たす地雷配分
   - 3人共通（---）と2人共通（++-系）の地雷数が同じ
   - AB, BC, CA共通の地雷数が同じ
   - 1人だけの地雷を避ける（+--パターンの回避）
3. **話題生成**: 地雷リストに関連する話題を生成

## 地雷の配分

### 配分方針

- **3人共通（---）**: 15個 - 全員が不機嫌になる話題
- **AB共通のみ（--+）**: 5個 - AとBが不機嫌、Cは平気
- **BC共通のみ（+--）**: 5個 - BとCが不機嫌、Aは平気
- **CA共通のみ（-+-）**: 5個 - CとAが不機嫌、Bは平気
- **合計**: 30個の話題

### 各ペルソナの地雷数

- **ペルソナA**: 25個（3人共通15 + AB共通5 + CA共通5）
- **ペルソナB**: 25個（3人共通15 + AB共通5 + BC共通5）
- **ペルソナC**: 25個（3人共通15 + BC共通5 + CA共通5）

### 構造の検証

✓ **---パターン**: 15個
✓ **++-系パターン**: 15個（5 + 5 + 5）
✓ **AB/BC/CA共通地雷**: 各20個（15 + 5）
✓ **1人だけの地雷**: 0個

## 地雷リスト

### 3人共通（---）15個

全員が不機嫌になる話題：

1. お金
2. 外見
3. 時間や締め切り
4. 健康
5. 仕事
6. 恋愛
7. 政治
8. 宗教
9. 法律・権利
10. 自然・環境
11. 家族
12. 友人
13. 交通
14. 天気
15. プライバシー・セキュリティ

### AB共通のみ（--+）5個

AとBが不機嫌、Cは平気：

1. 勉強
2. 研究
3. 読書
4. 歴史
5. 宇宙

### BC共通のみ（+--）5個

BとCが不機嫌、Aは平気：

1. ゲーム
2. アニメ
3. ドラマ
4. 音楽
5. 動物・ペット

### CA共通のみ（-+-）5個

CとAが不機嫌、Bは平気：

1. 旅行
2. 温泉
3. 食べ物
4. 映画
5. 国際・異文化

## 実装

### 1. 共通地雷検出 (`app/utils/trigger_detection.py`)

```python
def get_common_triggers_for_others(
    current_speaker: str,
    all_triggers: Dict[str, List[str]]
) -> List[str]:
    """
    他の2人に共通する地雷を検出（自分の地雷を除外）
    """
    # 他の2人の共通地雷を計算
    # 自分の地雷を除外
    # 結果を返す
```

### 2. プロンプト生成 (`app/humans_ollama.py`)

`build_human_prompt()`関数で、各ペルソナのプロンプトに以下を追加：

```
他の参加者（B, C）に共通する不機嫌トリガー：[共通地雷リスト]
これらの話題になった時は、[他の参加者] に優しく接してください。
```

### 3. 話題生成 (`app/config.local.yaml`)

話題生成プロンプトを更新して、地雷リストの話題に関連する具体的な話題を生成：

```yaml
topic_manager:
  generation_prompt: |
    以下のカテゴリーに関連する話題を生成してください：
    {trigger_examples}

    これらのカテゴリーに直接的または間接的に関連する具体的な話題を提案してください。
```

## 期待される動作

### ケース1: BC共通地雷の話題（例: ゲーム）

- **ペルソナA**: ゲームは自分の地雷ではないが、BとCに共通する地雷
  → **BとCに優しく接する**
- **ペルソナB**: ゲームは自分の地雷
  → **不機嫌になる**
- **ペルソナC**: ゲームは自分の地雷
  → **不機嫌になる**

**結果**: A-B関係 = +, A-C関係 = +, B-C関係 = - → **++-パターン（不安定）**

### ケース2: 3人共通地雷の話題（例: お金）

- **ペルソナA**: お金は自分の地雷
  → **不機嫌になる**（共通地雷でも自分の地雷なので優しくしない）
- **ペルソナB**: お金は自分の地雷
  → **不機嫌になる**
- **ペルソナC**: お金は自分の地雷
  → **不機嫌になる**

**結果**: A-B関係 = -, A-C関係 = -, B-C関係 = - → **---パターン（不安定）**

### ケース3: 地雷ではない話題（例: スポーツ）

- **ペルソナA**: スポーツは誰の地雷でもない
  → **穏やか**
- **ペルソナB**: スポーツは誰の地雷でもない
  → **穏やか**
- **ペルソナC**: スポーツは誰の地雷でもない
  → **穏やか**

**結果**: A-B関係 = +, A-C関係 = +, B-C関係 = + → **+++パターン（安定）**

## ロボットの役割

ロボットは、不安定なパターン（---や++-）を検出し、適切な介入によって安定パターン（+++または+--/-+-/--+）に導くことを学習します。

## テスト

以下のスクリプトで動作を確認できます：

- `test_common_triggers.py`: 共通地雷検出とプロンプト生成のテスト
- `verify_trigger_structure.py`: 地雷構造の検証

```bash
python test_common_triggers.py
python verify_trigger_structure.py
```

## 変更履歴

- 2025-XX-XX: 初版作成
  - 地雷の配分を3人共通15個、2人共通各5個に設定
  - 共通地雷検出ロジックに自分の地雷除外機能を追加
  - 話題生成プロンプトを地雷関連話題に変更
